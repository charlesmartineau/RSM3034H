---
title: "Lecture 1:<br><span style='color:#045282'>Cross-sectional Asset Pricing</span>"
subtitle: "PhD course in Empirical Asset Pricing"
author: "Charles Martineau"
institute: "Rotman | [www.charlesmartineau.com](https://www.charlesmartineau.com)"
bibliography: ../lit.bib
---

## Outline

- Unconditional CAPM
- Fama and French (1992)
- Fama and French (1993)

---

## Unconditional CAPM
```{=tex}
\begin{align}
E[r_i] = r_f + \beta_i E[r_m - r_f], 
\end{align}
```

where $r_f$ is the risk-free rate, $r_m$ is the market return, and $\beta_i$ is the beta of asset $i$.

\begin{align}
\beta_i = \frac{Cov(r_i, r_m)}{Var(r_m)}
\end{align}

- Assumption: $\beta_i$ is constant over time. Agents have homogenous beliefs, are mean-variance optimizers, and have access to the same information. 

---

## Empirical tests of the CAPM

Despite its popularity in the industry, the CAPM has been subject to criticism in asset pricing research. 

- For example, [Black, Jensen, and Scholes (1972)](https://papers.ssrn.com/sol3/papers.cfm?abstract_id=908569) and Fama and French (1992) among others document that market betas do not explain average asset returns in the cross-section.

---

## BJS (1972)

![](figures/BlackJensenScholes_1.jpg){.absolute .fragment width="40%"}

![](figures/BlackJensenScholes_2.jpg){.absolute .fragment width="1000"}

![](figures/BlackJensenScholes_3.jpg){.absolute .fragment width="1000"}

---

## Python coding exercise

Replication of the flat SML. 

Use 25 size-and-beta sorted portfolios as test assets.

---

## Python coding exercise

![](figures/sml.png){.absolute .center width="800"}

---

## Other empirical contradictions to the CAPM

- [Banz (1981)](https://www.sciencedirect.com/science/article/abs/pii/0304405X81900180) market equity, adds to the explanation of the cross-section of average returns provided by market $\beta$. 
  
- [Bhandari (1988)](https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1540-6261.1988.tb03952.x) find that leverage helps explain the cross-section of average stock returns in tests that include size as well as $\beta$.
  
---


## CAPM Test: French Beta Portfolios

```{python}
# | echo: true
# | output: false

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import statsmodels.api as sm

# Load Fama-French factors data (contains RF and Mkt-RF)
ff_factors = pd.read_excel("data_sample/ff_portfolios.xlsx")
ff_factors["date"] = pd.to_datetime(ff_factors["date"], format="%Y%m")
ff_factors = ff_factors.set_index("date")

# Load 10 beta-sorted portfolios
beta_portfolios = pd.read_excel("data_sample/ff_beta_sorted_portfolios.xlsx")
beta_portfolios["date"] = pd.to_datetime(beta_portfolios["date"], format="%Y%m")
beta_portfolios = beta_portfolios.set_index("date")

# Align dates between the two datasets
common_dates = beta_portfolios.index.intersection(ff_factors.index)
beta_portfolios = beta_portfolios.loc[common_dates]
ff_factors = ff_factors.loc[common_dates]

# Get portfolio column names (excluding date if present)
portfolio_cols = [col for col in beta_portfolios.columns if col not in ["date"]]

# Calculate betas for each portfolio using OLS regression
betas = []
for col in portfolio_cols:
    # Portfolio excess returns
    portfolio_excess = beta_portfolios[col] - ff_factors["RF"]
    market_excess = ff_factors["MKT_RF"]

    # Run OLS regression: portfolio_excess = alpha + beta * market_excess
    X = sm.add_constant(market_excess)
    model = sm.OLS(portfolio_excess, X)
    results = model.fit()
    beta = results.params[1]  # Beta is the slope coefficient
    betas.append(beta)

# Calculate average returns for each portfolio (annualized)
avg_returns = beta_portfolios[portfolio_cols].mean() * 12

# Get risk-free rate and market return (annualized)
rf_rate = ff_factors["RF"].mean() * 12
market_return = (ff_factors["MKT_RF"].mean() + ff_factors["RF"].mean()) * 12

# Create results DataFrame
results_df = pd.DataFrame(
    {
        "Portfolio": [f"Beta {i + 1}" for i in range(len(portfolio_cols))],
        "Beta": betas,
        "Avg Return (%)": avg_returns.values,
    }
)

print("Beta-Sorted Portfolios (Kenneth French Data):")
print(results_df.round(3))
print(f"\nRisk-free rate: {rf_rate:.2f}%")
print(f"Market return: {market_return:.2f}%")
print(f"Market risk premium: {(market_return - rf_rate):.2f}%")
```

## CAPM Test: Does It Hold?

```{python}
#| echo: false
#| fig-align: center

# Plot the Security Market Line with real data
fig, ax = plt.subplots(figsize=(10, 6))

# Plot theoretical SML (CAPM prediction)
beta_line = np.linspace(min(betas) - 0.1, max(betas) + 0.1, 100)
sml_line = rf_rate + beta_line * (market_return - rf_rate)
ax.plot(beta_line, sml_line, 'r-', linewidth=2, label='Theoretical SML (CAPM)', alpha=0.7)

# Fit a line through the actual portfolio data (Empirical SML)
from numpy.polynomial import Polynomial
p = Polynomial.fit(betas, avg_returns.values, 1)
empirical_sml = p(beta_line)

# Plot empirical SML (best fit line through portfolios)
ax.plot(beta_line, empirical_sml, 'g--', linewidth=2, label='Empirical SML (Best Fit)', alpha=0.7)

# Plot the actual portfolios
ax.scatter(betas, avg_returns.values, s=150, alpha=0.6, c='blue',
           edgecolors='navy', linewidth=2, label='Beta-Sorted Portfolios', zorder=5)

# Add portfolio labels
for i, (beta, ret) in enumerate(zip(betas, avg_returns.values)):
    ax.annotate(f'P{i+1}', (beta, ret), xytext=(5, 5),
                textcoords='offset points', fontsize=9, fontweight='bold')

ax.set_xlabel('Beta (β)', fontsize=12, fontweight='bold')
ax.set_ylabel('Average Annual Return (%)', fontsize=12, fontweight='bold')
ax.set_title('Security Market Line: Theory vs. Reality (1963-Present)',
             fontsize=14, fontweight='bold')
ax.legend(loc='upper left', fontsize=10)
ax.grid(True, alpha=0.3, linestyle='--')

plt.tight_layout()
plt.show()

# Calculate and display alpha for each portfolio
print("\nCAPM Prediction vs. Actual Returns:")
print("Portfolio | Beta  | Predicted Return | Actual Return | Alpha")
print("-" * 70)
for i, (beta, actual_ret) in enumerate(zip(betas, avg_returns.values)):
    predicted = rf_rate + beta * (market_return - rf_rate)
    alpha = actual_ret - predicted
    print(f"Beta {i+1:2d}   | {beta:.3f} | {predicted:6.2f}% | {actual_ret:6.2f}% | {alpha:+6.2f}%")
```

---

## Buy-and-Hold Returns

```{python}
#| echo: false
#| fig-align: center

# Calculate cumulative buy-and-hold returns for each portfolio
fig, ax = plt.subplots(figsize=(12, 7))

# Color palette for portfolios
colors = plt.cm.RdYlBu_r(np.linspace(0.1, 0.9, len(portfolio_cols)))

for idx, col in enumerate(portfolio_cols):
    # Calculate cumulative returns from raw returns
    cumulative_returns = (1 + beta_portfolios[col] / 100).cumprod()

    # Plot
    ax.plot(cumulative_returns.index, cumulative_returns,
            linewidth=2, label=f'Portfolio {idx+1} (β={betas[idx]:.2f})',
            color=colors[idx], alpha=0.8)

ax.set_xlabel('Date', fontsize=12, fontweight='bold')
ax.set_ylabel('Cumulative Return (%)', fontsize=12, fontweight='bold')
ax.set_title('Buy-and-Hold Returns: Beta-Sorted Portfolios',
             fontsize=14, fontweight='bold')
ax.legend(loc='best', fontsize=9, ncol=2)
ax.grid(True, alpha=0.3, linestyle='--')

plt.tight_layout()
plt.show()
```

- High-$\beta$ stocks earn less than predicted
- Low-$\beta$ stocks earn more than predicted


---

## Other empirical contradictions to the CAPM

- [Rosenberg, Reid, and Lanstein (1985)](https://www.degruyter.com/document/doi/10.1515/9781400829408-007/html), and [Chan, Hamao, and Lakonishok (1991)](https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1540-6261.1991.tb04642.x) find that book-to-market equity, BE/ME, also explains the cross-section of average returns. 
  
- [Basu (1983)](https://www.sciencedirect.com/science/article/abs/pii/0304405X83900314) shows that earnings-price ratios (E/P) also help explain the cross-section of average returns.


---

## Fama and French (1992)

[The Cross-Section of Expected Stock Returns](https://www.jstor.org/stable/2329112)

---

## Fama and MacBeth (1973) two-pass cross-sectional regression

```{=tex}
\begin{align}
r_{i,t} - r_{f,t} = \alpha_i + \lambda_{1} \beta_{i,t} + \lambda_{2} size_{i,t} + \lambda_{3} b/m_{i,t} + \epsilon_{i,t}
\end{align}
```

where $r_{i,t}$ is the return on asset $i$ at time $t$, $r_{f,t}$ is the risk-free rate at time $t$, $\beta_{i,t}$ is the beta of asset $i$ at time $t$, $size_{i,t}$ is the market capitalization of asset $i$ at time $t$, $b/m_{i,t}$ is the book-to-market equity of asset $i$ at time $t$.

How do we estimate the $\lambda$'s? 

- Run a regression for each time period $t$ and then average the coefficients across time.

In Python, we use the `linearmodels` package.

---

## Fama and French (1992) main results


![](figures/FF92_3.jpg){.absolute width="700"}

---

## How to run a FM regression in Python

```{.python code-line-numbers="1-2|4|6"}
from linearmodels import FamaMacBeth
from linearmodels.panel import generate_panel_data

panel_data = generate_panel_data()
panel_data = panel_data.data

mod = FamaMacBeth.from_formula("y ~ 1 + x1", panel_data).fit()
```

. . .

- Make sure that panel_data.data index is a `MultiIndex` with `entity` and `time` as levels, i.e., `permno` and `date`.

. . .


- E.g., `panel_data.index = panel_data.set_index(["permno", "date"])`

---

## Output {.smaller}

![](figures/fm_output.jpg){fig-align="center"}

::: footer
Next class: show how to format tables in Python for Latex.
:::

---

## Measuring CAPM-$\beta$

How do we assign a stock's CAPM-$\beta$? Read the paper. 

- Use the market model to estimate $\beta$ for each stock.
- Form size-beta-sorted portfolios. Size: Use NYSE breakpoints.
- Estimate the portfolio betas and assign the portfolio beta to each stock in the portfolio.
  - FF92, they average the betas of individual stocks in the portfolio.

---

## Post-ranking beta

![](figures/FF92_1B.jpg){fig-align="center"}

---

## Python coding exercise

You have all the codes to replicate FF92 main results (ignore book-to-market equity for the moment).

```{=tex}
\begin{align}
r_{i,t} - r_{f,t} = \alpha_i + \lambda_{1} \beta_{i,t} + \lambda_{2} size_{i,t} + \epsilon_{i,t}
\end{align}
```

How to proceed? Broad steps:

- First, create a panel data set with the required variables.
- Second, form beta-sorted portfolios and assign the portfolio beta to each stock in the portfolio.
- Third, run the Fama-MacBeth regression.

---

## Fama-French 1993
[Common risk factors in the returns on stocks and bonds](https://www.sciencedirect.com/science/article/abs/pii/0304405X93900235)

FF92 shows that size and book-to-market do a good job of explaining the cross-section of stock returns. 

<br>

FF93 extends FF92 in two ways:

::: incremental 
- Considers both stocks and bonds as test assets.
- If markets were integrated, a single model should also explain bond returns.
- Considers stock- (MKT, SMB, HML) and bond-related (TERM^[TERM: diff between LT govt bonds and t-bill - captures level of expected returns on bonds], DEF^[DEF: diff between return on LT bonds and LT gov bond - expected default risk.]) variables.
- Test assets are portfolios (FF25 + bond portfolios) rather than individual stocks.
- Empirical method: time-series tests rather than the cross-sectional approach of Fama-Macbeth as in FF92.
:::

---

## Fama-French 1993 

Main finding:

- SMB and HML explain the cross-section of stock returns and also bonds.


---

## Fama-French 1993

You can always use firm-level variables such as size and book-to-market to explain the cross-section. 

- But what if the premium on size and book-to-market captures systematic risk (e.g., default) and you want to use these "risk factors" to explain other asset returns (e.g., bonds) or portfolio returns?
  - Solution: Factor mimicking portfolios.


---

## Factor mimicking portfolios

Data requirements

- CRSP stock prices for December of t-1 and June of t
- Compustat book common equity for t-1
- Do not include firms until they have appeared on COMPUSTAT for two years, to address potential survivor bias (backfilling)
- Ordinary common equity included (exclude ADRs, REITs, and units of beneficial interest)


---

## Factor mimicking portfolios

June of year $t$ rank NYSE stocks on size

- All NYSE, AMEX, and Nasdaq stocks allocated to two groups based on NYSE breakpoints, S and B, cut on the median of NYSE market equity
- S contains about 80\% of the stocks in later years but 8\% of market value

---

## Factor mimicking portfolios


Independently create breakpoints for NYSE stock B/M ratio for low (30\%), middle (40\%), and high (30\%) groups, also in June of year $t$

- Book equity from fiscal year ending in $t-1$, ME from Dec. of $t-1$
- Omit stocks with negative BE in forming breakpoints
- Allocate NYSE, AMEX, and NASDAQ stocks according to break points, excluding those with negative BE

---

## Factor mimicking portfolios


Construct six double-sorted portfolios of Size and B/M sorts: S/L, S/M, S/H, B/L, B/M, B/H

- Calculate monthly value weighted returns from July of year t to June of year $t+1$, reforming portfolios in June of $t+1$.


---

## Factor mimicking portfolios 


Size (SMB)

- Difference, each month, between the simple average of the three small stock portfolios and the simple average of the three large stock portfolios

  - $\text{SMB} = \frac{1}{3}(\text{SL} + \text{SM} + \text{SH}) - \frac{1}{3}(\text{BL} + \text{BM} + \text{BH})$

Value (HML)

- Difference between the simple average of two high book-to-market portfolios and the simple average of two low book-to-market portfolios

  - $\text{HML} = \frac{1}{2}(\text{SH} + \text{BH}) - \frac{1}{2}(\text{SL} + \text{BL})$
---

## Fama-French 1993 main results

![](figures/FF93_9a.jpg){fig-align="center"}


---

## Fama-French 1993 main results

![](figures/FF93_9b.jpg){fig-align="center"}

--- 

## Fama-French 1993 GRS test

- Fama and French use the GRS test statistic to jointly test whether the alphas (αiαi​) of all the test portfolios are zero.
- The GRS test is designed to assess whether the factors  adequately explain the cross-sectional variation in returns across the test portfolios.

  - $\text{GRS} = \frac{T - N - K}{N} \cdot \frac{\alpha' \Sigma^{-1} \alpha}{1 + \bar{f}' \Sigma_f^{-1} \bar{f}}$ 

---

## Concerns with GRS tests

- The GRS test's results depend heavily on the chosen set of test portfolios.
- If portfolios are tailored to the factors (e.g., size and value factors for the Fama-French model), the test might favor the model even if it fails in a broader context, e.g., including industry portfolios.
- Other issues include GRS test assumes that factor returns and residuals are stationary over the sample period. See Harvey and Liu, 2021.

---


## Next class:

- Time-series predictability
- Two paper presentations

